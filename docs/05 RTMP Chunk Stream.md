# RTMP块流

本节指定实时消息传递协议区块流（RTMP区块流）。它为更高级的多媒体流协议提供多路复用和分组服务。

虽然RTMP区块流设计用于与实时消息协议（第6节）配合使用，但它可以处理发送消息流的任何协议。每条消息都包含时间戳和有效负载类型标识。RTMP Chunk Stream和RTMP一起适用于各种音频视频应用，从一对一和一对多直播到视频点播服务再到交互式会议应用。

当与可靠的传输协议（如TCP[RFC0793]）一起使用时，
RTMP区块流可以横跨多个流，并且保证所有消息按照时间戳的顺序有序地在端到端之间传递。RTMP区块流不提供任何优先级或类似形式的控制，但可由更高级别的协议用于提供此类优先级。例如，实时视频服务器可能会选择删除慢速客户端的视频消息，以确保根据发送时间或确认每条消息的时间及时接收音频消息。

RTMP区块流包含其自己的带内协议控制消息，并且还为更高级别的协议嵌入用户控制消息提供了一种机制。

## 消息格式
消息格式是否可以被拆分为块以便支持多路复用取决于更高级的协议。但是，消息格式应包含创建块所需的以下字段。

- Timestamp : 消息的时间戳。此字段可以传输4个字节。
- Length : 消息有效负载的长度。如果无法省略消息头，则应将其包含在长度中。此字段在区块头中占用3个字节。
- Type Id : 为协议控制消息保留了一系列类型ID。这些传播信息的消息由RTMP区块流协议和更高级别的协议处理。所有其他类型ID可供更高级别协议使用，并被RTMP区块流视为不透明值。事实上，RTMP区块流中的任何内容都不要求将这些值用作类型；所有（非协议）消息可以是相同的类型，或者应用程序可以使用此字段来区分同时跟踪而不是类型。此字段在区块头中占1字节。
- Message Stream ID : 消息流ID可以是任意值。复用到同一块流上的不同消息流根据其消息流ID进行解复用。除此之外，就RTMP块流而言，这是一个不透明的值。此字段以小尾端格式在块头中占据4个字节。

## 握手(Handshake)
RTMP连接从握手开始。握手与协议的其他部分不同；它由三个静态大小的块组成，而不是由带有标题的可变大小的块组成。

客户端（启动连接的端点）和服务器分别发送相同的三个数据块。为了方便说明，当客户端发送时，这些块将被指定为C0、C1和C2；而服务器发送时这些块被指定为S0、S1和S2。

### 握手顺序
握手从客户端发送C0和C1块开始。

客户端必须等到收到S1后再发送C2。在发送任何其他数据之前，客户端必须等到收到S2。

服务器在发送S0和S1之前必须等到收到C0，也可以等到C1之后。服务器必须等到收到C1后再发送S2。在发送任何其他数据之前，服务器必须等待收到C2。

### C0 和 S0 的格式
C0和S0数据包是一个八进制数字，被视作为一个8bit的整数字段：
```
             0 1 2 3 4 5 6 7
             +-+-+-+-+-+-+-+-+
             |    version    |
             +-+-+-+-+-+-+-+-+
             C0 and S0 bits

```
以下是C0/S0数据包中的字段：
Version (8 bits) : 在 C0 包内，这个字段代表客户端请求的 RTMP 版本号。在 S0 包内，这个字段代表服务端选择的 RTMP 版本号。当前使用的版本是 3。版本 0-2 用在早期的产品中，如今已经弃用；版本 4-31 被预留用于后续产品；版本 32-255 （为了区分 RTMP 协议和文本协议，文本协议通常是可以打印字符）不允许使用。如果服务器无法识别客户端的版本号，应该回复版本 3,。客户端可以选择降低到版本 3，或者终止握手过程。

### C1 和 S1 的格式：
C1 和 S1 包长度为 1536 字节，包含以下字段：
```
                 0                 1                     2                   3
                 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         time (4 bytes)                         |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         zero (4 bytes)                         |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         random bytes                           |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         random bytes                           |    
                 |                           (cont)                               |
                 |                           ....                                 |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 C1 and S1 bits

```












