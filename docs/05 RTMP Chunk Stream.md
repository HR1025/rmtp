# RTMP块流

本节指定实时消息传递协议区块流（RTMP区块流）。它为更高级的多媒体流协议提供多路复用和分组服务。

虽然RTMP区块流设计用于与实时消息协议（第6节）配合使用，但它可以处理发送消息流的任何协议。每条消息都包含时间戳和有效负载类型标识。RTMP Chunk Stream和RTMP一起适用于各种音频视频应用，从一对一和一对多直播到视频点播服务再到交互式会议应用。

当与可靠的传输协议（如TCP[RFC0793]）一起使用时，
RTMP区块流可以横跨多个流，并且保证所有消息按照时间戳的顺序有序地在端到端之间传递。RTMP区块流不提供任何优先级或类似形式的控制，但可由更高级别的协议用于提供此类优先级。例如，实时视频服务器可能会选择删除慢速客户端的视频消息，以确保根据发送时间或确认每条消息的时间及时接收音频消息。

RTMP区块流包含其自己的带内协议控制消息，并且还为更高级别的协议嵌入用户控制消息提供了一种机制。

## 消息格式
消息格式是否可以被拆分为块以便支持多路复用取决于更高级的协议。但是，消息格式应包含创建块所需的以下字段。

- Timestamp : 消息的时间戳。此字段可以传输4个字节。
- Length : 消息有效负载的长度。如果无法省略消息头，则应将其包含在长度中。此字段在区块头中占用3个字节。
- Type Id : 为协议控制消息保留了一系列类型ID。这些传播信息的消息由RTMP区块流协议和更高级别的协议处理。所有其他类型ID可供更高级别协议使用，并被RTMP区块流视为不透明值。事实上，RTMP区块流中的任何内容都不要求将这些值用作类型；所有（非协议）消息可以是相同的类型，或者应用程序可以使用此字段来区分同时跟踪而不是类型。此字段在区块头中占1字节。
- Message Stream ID : 消息流ID可以是任意值。复用到同一块流上的不同消息流根据其消息流ID进行解复用。除此之外，就RTMP块流而言，这是一个不透明的值。此字段以小尾端格式在块头中占据4个字节。

## 握手(Handshake)
RTMP连接从握手开始。握手与协议的其他部分不同；它由三个静态大小的块组成，而不是由带有标题的可变大小的块组成。

客户端（启动连接的端点）和服务器分别发送相同的三个数据块。为了方便说明，当客户端发送时，这些块将被指定为C0、C1和C2；而服务器发送时这些块被指定为S0、S1和S2。

### 握手顺序
握手从客户端发送C0和C1块开始。

客户端必须等到收到S1后再发送C2。在发送任何其他数据之前，客户端必须等到收到S2。

服务器在发送S0和S1之前必须等到收到C0，也可以等到C1之后。服务器必须等到收到C1后再发送S2。在发送任何其他数据之前，服务器必须等待收到C2。

### C0 和 S0 的格式
C0和S0数据包是一个八进制数字，被视作为一个8bit的整数字段：
```
             0 1 2 3 4 5 6 7
             +-+-+-+-+-+-+-+-+
             |    version    |
             +-+-+-+-+-+-+-+-+
             C0 and S0 bits

```
以下是C0/S0数据包中的字段：
- Version (8 bits) : 在 C0 包内，这个字段代表客户端请求的 RTMP 版本号。在 S0 包内，这个字段代表服务端选择的 RTMP 版本号。当前使用的版本是 3。版本 0-2 用在早期的产品中，如今已经弃用；版本 4-31 被预留用于后续产品；版本 32-255 （为了区分 RTMP 协议和文本协议，文本协议通常是可以打印字符）不允许使用。如果服务器无法识别客户端的版本号，应该回复版本 3,。客户端可以选择降低到版本 3，或者终止握手过程。

### C1 和 S1 的格式：
C1 和 S1 包长度为 1536 字节，包含以下字段：
```
                 0                 1                     2                   3
                 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         time (4 bytes)                        |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         zero (4 bytes)                        |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         random bytes                          |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         random bytes                          |    
                 |                           (cont)                              |
                 |                           ....                                |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                         C1 and S1 bits

```
- Time（4 bytes）：本字段包含一个时间戳，客户端应该使用此字段来标识所有流块的时刻。时间戳取值可以为零或其他任意值。为了同步多个块流，客户端可能希望发送另一个快流时间戳的当前值。
- zero（4 bytes）：本字段必须为零。
- random （1528 bytes）：此字段可以包含任意值。由于每个端点都必须区分它发起的握手响应和它的对等方发起的握手响应，因此该数据应该发送足够随机的信息。但不需要加密安全的随机性，甚至不需要动态值。

### C2 和 S2 的格式
C2和S2数据包的长度为1536个字节，几乎是S1和C1的拷贝，由以下字段组成：
```
                 0                   1                   2                   3
                 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         time (4 bytes)                        |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         time2 (4 bytes)                       |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         random echo                           |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |                         random echo                           |
                 |                           (cont)                              |
                 |                           ....                                |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                          C2 and S2 bits
```
- Time (4 bytes) : 此字段必须包含S1（对于C2）或C1（对于S2）中对等方发送的时间戳。
- Time2 (4 bytes) : 此字段必须包含读取对等方发送的前一个数据包（s1或c1）的时间戳。
- Random echo (1528 bytes) : 此字段必须包含S1（对于C2）或S2（对于C1）中对等方发送的随机数据字段。任何一个对等方都可以将time和time2字段与当前时间戳一起用作连接带宽和/或延迟的快速估计，但这不太可能有用。

### 握手图
``` 
                 +-------------+                            +-------------+
                 |    Client   |       TCP/IP Network       |    Server   |
                 +-------------+             |              +-------------+
                        |                    |                     |
                   Uninitialized             |                Uninitialized
                        |       C0           |                     |
                        |------------------->|         C0          |
                        |                    |-------------------->|
                        |       C1           |                     |
                        |------------------->|         S0          |
                        |                    |<--------------------|
                        |                    |         S1          |
                    Version sent             |<--------------------|
                        |       S0           |                     |
                        |<-------------------|                     |
                        |       S1           |                     |
                        |<-------------------|                Version sent
                        |                    |         C1          |
                        |                    |-------------------->|
                        |       C2           |                     |
                        |------------------->|         S2          |
                        |                    |<--------------------|
                    Ack sent                 |                  Ack Sent
                        |       S2           |                     |
                        |<-------------------|                     |
                        |                    |         C2          |
                        |                    |-------------------->|
                 Handshake Done              |                Handshake Done
                        |                    |                     |
                            Pictorial Representation of Handshake
```
以下描述了握手图中提到的状态：
- Uninitialized : 协议版本在此阶段发送。客户端和服务器都未初始化。客户端发送数据包C0中的协议版本。如果服务器支持该版本，则会发送S0和S1作为响应。如果没有，服务器将通过采取适当的操作进行响应。在RTMP中，此操作是终止连接。
- Version Sent : 在未初始化状态之后，客户端和服务器都处于版本发送状态。客户端正在等待分组S1，服务器正在等待分组C1。在接收到等待的分组时，客户端发送分组C2，服务器发送分组S2。然后，状态变为Ack Sent。
- Ack Sent : 客户端和服务器分别等待S2和C2。
- Handshake Done : 客户端和服务器交换消息。

## 分块
在经历握手后，这个连接会多路复用一个或者多个块流。每个区块流携带来自一个消息流的一种类型的消息。创建的每个区块都有一个与之关联的唯一ID，称为区块流ID(chunk stream ID)。块通过网络传输。传输时，必须在下一个数据块之前完整发送每个数据块。在接收端，根据区块流ID将区块组装成消息。

分块允许将高级协议中的大型消息分解为较小的消息，例如，防止大型低优先级消息（如视频）阻止较小的高优先级消息（如音频或控制）。

分块还允许以较少的开销发送小消息，因为分块头包含信息的压缩形式，否则必须包含在消息本身中。

区块大小是可配置的。它可以使用 Set Chunk Size control message 设置。较大的块大小可以减少CPU使用，但也会导致较大的写操作，从而延迟低带宽连接上的其他内容。较小的数据块不适用于高比特率流。块大小在每个方向上都是独立保持的。

### 块格式
每个块由一个头部以及数据组成。头部本身有三个部分：
``` 
             +--------------+----------------+--------------------+--------------+
             | Basic Header | Message Header | Extended Timestamp | Chunk Data   |
             +--------------+----------------+--------------------+--------------+
             |                                                                   |
             |<------------------- Chunk Header ----------------->|
                                     Chunk Format

```
- Basic Header (1 to 3 bytes) : 此字段对区块流ID(chunk stream ID)和区块类型(chunk type)进行编码。区块类型确定编码消息头的格式(Message Header)。长度完全取决于区块流ID，它是一个可变长度字段。
- Message Header (0, 3, 7, or 11 bytes) : 此字段编码有关正在发送的消息的信息（无论是全部还是部分）。可以使用区块头(chunk header)中指定的区块类型(chunk type)确定长度。
- Extended Timestamp (0 or 4 bytes) : 根据区块消息头中的编码时间戳或时间戳增量字段，此字段在某些情况下存在。
- Chunk Data (variable size) : 此区块的有效负载，最大为配置的最大区块大小。

#### 块基本头部(Chunk Basic Header)
Chunk Basic Header 对区块流ID和区块类型进行编码（由下图中的fmt字段表示）。区块类型确定编码消息头的格式。区块基本标头字段可以是1、2或3字节，具体取决于区块流ID。

一个好的实现将会以最小的表达形式来存储 ID。

该协议最多支持65597个ID为3-65599的流。ID 0、1和2被保留。值0表示2字节形式和64-319范围内的ID（第二个字节+64）。值1表示3字节形式和64-65599范围内的ID（（第三个字节）*256+第二个字节+64）。范围为3-63的值表示完整的流ID。值为2的区块流ID保留用于低级协议控制消息和命令。区块基本标头中的位0-5（least significant）表示区块流ID。块流 ID 2-63 在这个字段中可以以1字节的形式编码。 
```
                  0 1 2 3 4 5 6 7
                 +-+-+-+-+-+-+-+-+
                 |fmt|    cs id  |
                 +-+-+-+-+-+-+-+-+
                 Chunk basic header 1 
```

区块流ID 64-319可以以头的2字节形式编码。ID计算为（第二个字节+64）。
```
                  0               1
                  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |fmt|0          | cs id - 64    |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      Chunk basic header 2
```
块流ID 64-65599可以在此字段的3字节版本中进行编码。ID计算为（（第三个字节）*256+（第二个字节）+64）。
```
                  0               1               2
                  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |fmt|1          |        cs id - 64             |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                            Chunk basic header 3
```
- cs id (6 bits) : 此字段包含区块流ID，值范围为2-63。值0和1用于指示此字段的2字节或3字节版本。
- fmt (2 bits) : 此字段标识“区块消息头(chunk message header)”使用的四种格式之一。
- cs id - 64 (8 or 16 bits) : 此字段包含区块流ID减去64。例如，ID 365将由cs id中的1和此字段16位形式的301表示。

#### 块消息头部(Chunk Message Header)
块消息头(Chunk Message Header)有四种不同的格式，由块基本头部(Chunk Basic Header)中的“fmt”字段选择。

实现应该为每个块消息头部使用尽可能紧凑的表示。

##### Type 0
类型0块头的长度为11字节。此类型必须在块流的开始以及流时间戳向后时使用（例如，由于向后搜索）。
```
                  0               1               2               3
                  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |             timestamp                         |message length |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |    message length (cont)      |message type id| msg stream id |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                 |          message stream id (cont)             |
                 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                    Chunk Message Header - Type 0
```


































